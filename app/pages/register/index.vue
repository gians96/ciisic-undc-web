<template>
    <div>
        <!-- ===========================================================================
        ENCABEZADO DE PÁGINA
        ============================================================================ -->
        <section class="breadcrumb-area">
            <div class="breadcrumb-container">
                <h1 class="page-title">{{ selectedPlan?.title || 'REGISTRO' }} - VII CIISIC</h1>
                <p class="page-subtitle">{{ selectedPlan?.description }}</p>
            </div>
        </section>

        <!-- ===========================================================================
        SISTEMA DE NOTIFICACIONES
        ============================================================================ -->
        <NotificationSystem :error-message="errorMessage" :success-message="successMessage"
            :show-action-button="!!completedInscriptionId" action-button-text="Ver confirmación"
            @clear-error="errorMessage = ''" @clear-success="successMessage = ''" @action="goToConfirmation" />



        <!-- ===========================================================================
        SECCIÓN DEL FORMULARIO
        ============================================================================ -->
        <section class="form-section">
            <div class="form-container">
                <form @submit.prevent="handleSubmit" class="registration-form">

                    <!-- Fila 1: Documento (Tipo + Número), Nombres, Apellidos -->
                    <div class="form-group col-span-6 md:col-span-3 lg:col-span-2">
                        <label for="documentType" class="form-label">Documento de identidad</label>
                        <div class="document-input-group">
                            <div class="document-type-container">
                                <select id="documentType" v-model="documentType" class="document-type-select" required>
                                    <option v-for="type in documentTypes" :key="type.value" :value="type.value">
                                        {{ type.value }}
                                    </option>
                                </select>
                                <Icon name="heroicons:chevron-down" class="document-type-arrow" />
                            </div>
                            <div class="document-number-container">
                                <input id="documentNumber" v-model="documentNumber" type="text"
                                    :placeholder="getSelectedDocumentType()?.placeholder || 'Número de documento'"
                                    :maxlength="getSelectedDocumentType()?.maxLength || 8"
                                    :pattern="getSelectedDocumentType()?.pattern || '[0-9]{8}'"
                                    @input="handleDocumentInput" required class="document-number-input">
                                <button type="button" @click="handleDocumentSearch"
                                    :disabled="isSearchingDni || !isDocumentNumberComplete()"
                                    class="document-search-button" aria-label="Buscar documento">
                                    <Icon v-if="isSearchingDni" name="heroicons:arrow-path"
                                        class="h-5 w-5 animate-spin" />
                                    <Icon v-else name="heroicons:magnifying-glass" class="h-5 w-5" />
                                </button>
                            </div>
                        </div>
                        <small class="form-hint">
                            {{ getSelectedDocumentType()?.maxLength || 8 }} dígitos.
                            {{ isDocumentNumberComplete() ? 'Presiona la lupa para buscar.' : `Faltan
                            ${getRemainingDigits()} dígitos.` }}
                        </small>
                    </div>

                    <div class="form-group col-span-6 md:col-span-3 lg:col-span-2">
                        <label for="nombres" class="form-label">Nombres</label>
                        <input id="nombres" v-model="nombres" type="text" placeholder="Nombres (autocompletado)"
                            class="form-input" :class="{ 'input-filled': nombres }" required>
                    </div>

                    <div class="form-group col-span-6 md:col-span-3 lg:col-span-2">
                        <label for="apellidos" class="form-label">Apellidos</label>
                        <input id="apellidos" v-model="apellidos" type="text" placeholder="Apellidos (autocompletado)"
                            class="form-input" :class="{ 'input-filled': apellidos }" required>
                    </div>

                    <!-- Fila 2: Correo, Celular -->
                    <div class="form-group col-span-6 md:col-span-3">
                        <label for="email" class="form-label">Correo electrónico</label>
                        <input id="email" v-model="email" type="email" placeholder="Tu correo electrónico" required
                            class="form-input">
                        <small class="form-hint">{{ getEmailHint() }}</small>
                    </div>

                    <div class="form-group col-span-6 md:col-span-3">
                        <label for="celular" class="form-label">Celular</label>
                        <input id="celular" v-model="celular" type="tel" placeholder="Tu número de celular" required
                            class="form-input" pattern="[9][0-9]{8}" maxlength="9">
                        <small class="form-hint">9 dígitos sin espacios</small>
                    </div>


                    <!-- Selección de Tipo de Inscripción - Cards Compactas -->
                    <div class="form-group col-span-6 form-section-below-classification">
                        <label class="form-label">Tipo de inscripción</label>
                        <div class="plan-cards-container">
                            <div v-for="plan in availablePlans" :key="plan.id" @click="selectPlan(plan.id)"
                                class="plan-card-compact" :class="{ 'selected': planId === plan.id }">
                                <div class="plan-card-header">
                                    <div class="plan-title-container">
                                        <h4 class="plan-card-title">{{ plan.title }}</h4>
                                        <span class="plan-card-badge" :class="getBadgeClass(plan.badge)">{{ plan.badge
                                            }}</span>

                                    </div>
                                </div>
                                <div class="plan-price-container">
                                    <div class="plan-card-price">{{ plan.price }}</div>
                                    <!-- Icono de información con tooltip -->
                                    <div class="plan-info-tooltip-container">
                                        <Icon @click.prevent.stop name="heroicons:information-circle"
                                            class="plan-info-icon" />
                                        <div class="plan-tooltip">
                                            <!-- <div class="plan-tooltip-title">{{ plan.title }}</div> -->
                                            <!-- <div class="plan-tooltip-price">{{ plan.price }}</div> -->
                                            <div class="plan-tooltip-features">
                                                <div v-for="feature in plan.features" :key="feature.text"
                                                    class="plan-tooltip-feature">
                                                    <Icon :name="feature.icon" class="plan-feature-icon"
                                                        :class="{ 'feature-excluded': feature.icon === 'heroicons:x-mark' }" />
                                                    <span
                                                        :class="{ 'feature-excluded-text': feature.icon === 'heroicons:x-mark' }">
                                                        {{ feature.text }}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="plan-tooltip-arrow"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="plan-card-description">{{ plan.description }}</div>

                                <!-- Icono de selección -->
                                <div class="plan-card-selector">
                                    <div class="plan-selector-radio" :class="{ 'selected': planId === plan.id }">
                                        <div v-if="planId === plan.id" class="plan-selector-dot"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <small class="form-hint">Selecciona el plan que mejor se adapte a tus necesidades - Hover sobre
                            <Icon name="heroicons:information-circle" class="inline h-4 w-4 text-blue-400" /> para ver
                            detalles
                        </small>
                    </div>
                    <!-- Campo de clasificación para estudiantes con transición avanzada -->
                    <Transition name="height-expand" @enter="onClassificationEnter" @leave="onClassificationLeave"
                        @before-enter="onClassificationBeforeEnter" @after-enter="onClassificationAfterEnter"
                        @before-leave="onClassificationBeforeLeave" @after-leave="onClassificationAfterLeave">
                        <div v-if="isStudentPlan" class="classification-container col-span-6 md:col-span-3">
                            <div class="form-group">
                                <label for="clasificacion" class="form-label">Clasificación</label>
                                <select id="clasificacion" v-model="clasificacion" required class="form-input">
                                    <option value="" disabled selected>Selecciona una opción</option>
                                    <option value="DOCENTE">DOCENTE</option>
                                    <option value="POSGRADO">POSGRADO</option>
                                    <option value="ESTUDIANTE - I CICLO">ESTUDIANTE - I CICLO</option>
                                    <option value="ESTUDIANTE - II CICLO">ESTUDIANTE - II CICLO</option>
                                    <option value="ESTUDIANTE - III CICLO">ESTUDIANTE - III CICLO</option>
                                    <option value="ESTUDIANTE - IV CICLO">ESTUDIANTE - IV CICLO</option>
                                    <option value="ESTUDIANTE - V CICLO">ESTUDIANTE - V CICLO</option>
                                    <option value="ESTUDIANTE - VI CICLO">ESTUDIANTE - VI CICLO</option>
                                    <option value="ESTUDIANTE - VII CICLO">ESTUDIANTE - VII CICLO</option>
                                    <option value="ESTUDIANTE - VIII CICLO">ESTUDIANTE - VIII CICLO</option>
                                    <option value="ESTUDIANTE - IX CICLO">ESTUDIANTE - IX CICLO</option>
                                    <option value="ESTUDIANTE - X CICLO">ESTUDIANTE - X CICLO</option>
                                </select>
                                <small class="form-hint">Indica el ciclo al que perteneces</small>
                            </div>
                        </div>
                    </Transition>

                    <!-- Línea Divisoria -->
                    <div class="col-span-6 form-section-below-classification">
                        <div class="w-full border-t border-slate-700"></div>
                    </div>

                    <!-- Sección de Pago -->
                    <div
                        class="col-span-6 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8 form-section-below-classification">

                        <!-- Columna Izquierda: Modalidad de Pago -->
                        <div class="conditional-section flex flex-col justify-center">
                            <div class="form-group">
                                <label class="form-label">Modalidad de Depósito</label>
                                <div class="radio-group-horizontal">
                                    <label for="bancoNacion" class="radio-label">
                                        <input id="bancoNacion" v-model="modalidadDeposito" type="radio" value="banco"
                                            class="sr-only">
                                        <div class="radio-custom-indicator"
                                            :class="{ 'selected': modalidadDeposito === 'banco' }">
                                            <div v-if="modalidadDeposito === 'banco'" class="radio-dot"></div>
                                        </div>
                                        <div class="relative flex items-center group">
                                            <span>Banco de la Nación</span>
                                            <Icon @click.prevent.stop name="heroicons:information-circle"
                                                class="ml-2 text-gray-400 cursor-pointer h-6 w-6" />
                                            <div class="tooltip">
                                                <div>- N° Cuenta: 04-029-958659</div>
                                                <div>(Cendy Girao)</div>
                                                <div class="tooltip-arrow"></div>
                                            </div>
                                        </div>
                                    </label>
                                    <label for="billeteraDigital" class="radio-label">
                                        <input id="billeteraDigital" v-model="modalidadDeposito" type="radio"
                                            value="billetera" class="sr-only">
                                        <div class="radio-custom-indicator"
                                            :class="{ 'selected': modalidadDeposito === 'billetera' }">
                                            <div v-if="modalidadDeposito === 'billetera'" class="radio-dot"></div>
                                        </div>
                                        <div class="relative flex items-center group">
                                            <span>Billetera Digital</span>
                                            <Icon @click.prevent.stop name="heroicons:information-circle"
                                                class="ml-2 text-gray-400 cursor-pointer h-6 w-6" />
                                            <div class="tooltip">
                                                <div>Número de Yape: 987654321</div>
                                                <div>UNDC</div>
                                                <div class="tooltip-arrow"></div>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                <small class="form-hint">Selecciona el medio de pago</small>
                            </div>

                            <Transition name="fade" mode="out-in">
                                <div v-if="modalidadDeposito === 'banco'" class="form-group mt-4">
                                    <label class="form-label">Tipo de Pago</label>
                                    <div class="radio-group-horizontal">
                                        <label for="pagoDirecto" class="radio-label">
                                            <input id="pagoDirecto" v-model="tipoPago" type="radio" value="directo"
                                                class="sr-only">
                                            <div class="radio-custom-indicator"
                                                :class="{ 'selected': tipoPago === 'directo' }">
                                                <div v-if="tipoPago === 'directo'" class="radio-dot"></div>
                                            </div>
                                            <span>Pago Directo</span>
                                        </label>
                                        <label for="pagoInterbancario" class="radio-label">
                                            <input id="pagoInterbancario" v-model="tipoPago" type="radio"
                                                value="interbancario" class="sr-only">
                                            <div class="radio-custom-indicator"
                                                :class="{ 'selected': tipoPago === 'interbancario' }">
                                                <div v-if="tipoPago === 'interbancario'" class="radio-dot"></div>
                                            </div>
                                            <span>Pago interbancario</span>
                                        </label>
                                    </div>
                                    <small class="form-hint">Selecciona el tipo de pago</small>
                                </div>
                                <div v-else-if="modalidadDeposito === 'billetera'" class="form-group mt-4">
                                    <label class="form-label">Aplicativo</label>
                                    <div class="radio-group-horizontal">
                                        <label for="yape" class="radio-label">
                                            <input id="yape" v-model="aplicativo" type="radio" value="yape"
                                                class="sr-only">
                                            <div class="radio-custom-indicator"
                                                :class="{ 'selected': aplicativo === 'yape' }">
                                                <div v-if="aplicativo === 'yape'" class="radio-dot"></div>
                                            </div>
                                            <span>Yape</span>
                                        </label>
                                        <label for="plin" class="radio-label">
                                            <input id="plin" v-model="aplicativo" type="radio" value="plin"
                                                class="sr-only">
                                            <div class="radio-custom-indicator"
                                                :class="{ 'selected': aplicativo === 'plin' }">
                                                <div v-if="aplicativo === 'plin'" class="radio-dot"></div>
                                            </div>
                                            <span>Plin</span>
                                        </label>
                                    </div>
                                    <small class="form-hint">Selecciona el aplicativo</small>
                                </div>
                            </Transition>
                        </div>

                        <!-- Columna Derecha: Información del Pago -->
                        <div class="flex flex-col justify-between gap-y-8">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-8">
                                <div class="form-group">
                                    <label for="codigoVoucher" class="form-label">Código del voucher de pago</label>
                                    <input id="codigoVoucher" v-model="codigoVoucher" type="text"
                                        placeholder="Código de operación" required class="form-input">
                                    <small class="form-hint">Digita el código de pago</small>
                                </div>
                                <div class="form-group">
                                    <label for="fechaPago" class="form-label">Fecha de Pago</label>
                                    <input id="fechaPago" v-model="fechaPago" type="date" required class="form-input">
                                    <small class="form-hint">Indica la fecha de pago</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adjuntar voucher de pago</label>
                                <label for="archivoVoucher" class="file-input-wrapper"
                                    :class="{ 'file-input-completed': archivoVoucher }">
                                    <div class="file-input-button">Seleccionar archivo</div>
                                    <div class="file-input-text-area">
                                        {{ archivoVoucher ? archivoVoucher.name : 'Sin archivos seleccionados' }}
                                    </div>
                                </label>
                                <input id="archivoVoucher" type="file" @change="handleFileChange" required
                                    class="sr-only" accept="image/jpeg,image/png,image/jpg,application/pdf">
                                <small class="form-hint">Sube el voucher en JPG, JPEG, PNG o PDF (máx. 5MB)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Botón de Envío -->
                    <div class="col-span-6 form-section-below-classification">
                        <button type="submit" class="submit-button" :disabled="isSubmitting">
                            <Icon v-if="isSubmitting" name="heroicons:arrow-path" class="h-5 w-5 animate-spin mr-2" />
                            {{ isSubmitting ? 'Procesando...' : 'Completar Inscripción' }}
                        </button>
                    </div>
                </form>
            </div>
        </section>
    </div>
</template>

<script setup lang="ts">
// ===========================================================================
// SEO Y META TAGS
// ===========================================================================
useHead({
    title: 'Registro - VII CIISIC UNDC',
    meta: [
        { name: 'description', content: 'Formulario de registro para el VII Congreso Internacional de Ingeniería de Sistemas e Informática de la UNDC.' }
    ]
})

// ===========================================================================
// TYPES E INTERFACES
// ===========================================================================
interface PlanFormatted {
    id: number
    title: string
    badge: string
    price: string
    value: string
    description: string
    features: { icon: string; text: string }[]
}

// ===========================================================================
// COMPOSABLES Y ROUTER
// ===========================================================================
const { consultDni, documentTypes } = useConsultation()
const {
    createInscription,
    initializeCatalogs,
    mapFormDataToApiData,
    isSubmitting: apiSubmitting,
    error: apiError,
    clearError,
    registrationTypes,
    classifications,
    depositMethods,
    paymentTypes
} = useInscription()
const route = useRoute()
const router = useRouter()
const config = useRuntimeConfig()

const searchConsultation = async (number: string) => {
    if (import.meta.server) {
        const documentType = number.length === 8 ? 'DNI' : 'CE'
        // / Hacer la petición a la API externa desde el servidor
        const endpoint = documentType === 'DNI' ? 'dni' : 'ce'
        const requestUrl = `${config.xApiUrl}/${endpoint}/${number}`
        const response = await $fetch(requestUrl, {
            headers: {
                'X-API-Token': config.xApiToken,
                'Content-Type': 'application/json'
            }
        })
    }
}

// ===========================================================================
// STORES
// ===========================================================================
const inscriptionPlansStore = useInscriptionPlansStore()

// ===========================================================================
// PLANES DE INSCRIPCIÓN - DATOS DINÁMICOS
// ===========================================================================
// Cargar planes al inicializar la página
const loadingPlans = ref(true)

onMounted(async () => {
    try {
        // Intentar cargar planes desde API
        await inscriptionPlansStore.fetchPlans()
        console.log('✅ Planes cargados en la página de registro')
    } catch (error) {
        console.warn('⚠️ Error cargando planes, usando datos por defecto')
        // Los datos por defecto ya están disponibles en el store
    } finally {
        loadingPlans.value = false
    }
})

// Computed para obtener los planes desde el store
const inscriptionPlans = computed(() => inscriptionPlansStore.plansFormatted)

// ===========================================================================
// COMPUTED Y REACTIVOS
// ===========================================================================
const planId = computed(() => parseInt(route.query.planId as string) || 1)
const selectedPlan = computed(() => inscriptionPlans.value.find((plan: PlanFormatted) => plan.id === planId.value))
const isStudentPlan = computed(() => planId.value === 1 || planId.value === 2)
const availablePlans = computed(() => inscriptionPlans.value)

// ===========================================================================
// ESTADO DEL FORMULARIO
// ===========================================================================
const documentType = ref<'DNI' | 'CE'>('DNI')
const documentNumber = ref<string>('')
const nombres = ref<string>('')
const apellidos = ref<string>('')
const email = ref<string>('')
const celular = ref<string>('')
const clasificacion = ref<string>('')
const tipoInscripcion = ref<string>('')
const modalidadDeposito = ref<'banco' | 'billetera'>('banco')
const tipoPago = ref<'directo' | 'interbancario' | null>(null)
const aplicativo = ref<'yape' | 'plin' | null>(null)
const fechaPago = ref<string>('')
const codigoVoucher = ref<string>('')
const archivoVoucher = ref<File | null>(null)
const isSearchingDni = ref(false)
const isSubmitting = ref(false)
const errorMessage = ref<string>('')
const successMessage = ref<string>('')
const completedInscriptionId = ref<number | null>(null)

// ===========================================================================
// WATCHERS
// ===========================================================================
watch(planId, (newPlanId) => {
    if (!selectedPlan.value) {
        router.push('/register?planId=1')
    } else {
        // Preseleccionar el tipo de inscripción basado en el planId
        tipoInscripcion.value = selectedPlan.value.value
    }
}, { immediate: true })

watch(modalidadDeposito, (newVal, oldVal) => {
    if (newVal !== oldVal) {
        tipoPago.value = null
        aplicativo.value = null
    }
})

watch(documentType, () => {
    documentNumber.value = ''
    nombres.value = ''
    apellidos.value = ''
})

watch(documentNumber, (newValue) => {
    if (isDocumentNumberComplete() && newValue.length === getSelectedDocumentType()?.maxLength) {
        handleDocumentSearch()
    }
})

// ===========================================================================
// MÉTODOS AUXILIARES
// ===========================================================================
const getBadgeClass = (badge: string) => {
    return badge.includes('SIN') ? 'badge-warning' : 'badge-success'
}

const getEmailHint = () => {
    return isStudentPlan.value ? 'Debe ser el correo institucional' : 'Tu correo electrónico'
}

const getSelectedDocumentType = () => {
    return documentTypes.find(type => type.value === documentType.value)
}

const isDocumentNumberComplete = () => {
    const expectedLength = getSelectedDocumentType()?.maxLength || 8
    return documentNumber.value.length === expectedLength
}

const getRemainingDigits = () => {
    const expectedLength = getSelectedDocumentType()?.maxLength || 8
    return Math.max(0, expectedLength - documentNumber.value.length)
}

const showError = (message: string) => {
    errorMessage.value = message
    successMessage.value = ''
    console.error('🔴 Error:', message)

    // Auto-limpiar después de 5 segundos
    setTimeout(() => {
        errorMessage.value = ''
    }, 2500)
}

const showSuccess = (message: string) => {
    successMessage.value = message
    errorMessage.value = ''
    console.log('✅ Success:', message)

    // Auto-limpiar después de 5 segundos (aumenté el tiempo por si el usuario quiere hacer clic)
    setTimeout(() => {
        successMessage.value = ''
        completedInscriptionId.value = null
    }, 2500)
}

const goToConfirmation = () => {
    console.log('🔄 Intentando ir a confirmación...', {
        inscriptionId: completedInscriptionId.value,
        hasRouter: !!router
    })

    if (completedInscriptionId.value) {
        const confirmationUrl = `/confirmation?id=${completedInscriptionId.value}`
        console.log('🔄 Navegando a:', confirmationUrl)

        router.push(confirmationUrl).then(() => {
            console.log('✅ Navegación exitosa')
            successMessage.value = ''
            completedInscriptionId.value = null
        }).catch((error) => {
            console.error('❌ Error en navegación:', error)
            // Fallback: intenta con window.location
            window.location.href = confirmationUrl
        })
    } else {
        console.error('❌ No hay ID de inscripción para redireccionar')
        showError('Error: No se puede acceder a la página de confirmación. ID de inscripción no encontrado.')
    }
}

// ===========================================================================
// MANEJADORES DE EVENTOS
// ===========================================================================
const selectPlan = (newPlanId: number) => {
    // Cambiar la URI como en Digital Ocean
    router.push(`/register?planId=${newPlanId}`)
}

const handleDocumentInput = (event: Event) => {
    const target = event.target as HTMLInputElement
    const numericValue = target.value.replace(/\D/g, '')
    const maxLength = getSelectedDocumentType()?.maxLength || 8

    errorMessage.value = ''
    documentNumber.value = numericValue.slice(0, maxLength)
    target.value = documentNumber.value
}

const handleDocumentSearch = async () => {
    if (!isDocumentNumberComplete()) {
        const expectedLength = getSelectedDocumentType()?.maxLength || 8
        showError(`Por favor, ingrese un ${documentType.value} válido de ${expectedLength} dígitos.`)
        return
    }

    isSearchingDni.value = true
    nombres.value = ''
    apellidos.value = ''
    errorMessage.value = ''

    try {
        console.log(`🔍 Consultando ${documentType.value}: ${documentNumber.value}`)

        const result = await consultDni(documentNumber.value, documentType.value)

        console.log('📥 Resultado recibido:', result)

        if (result && result.success && result.data) {
            if (result.data.names && (result.data.paternalSurname || result.data.maternalSurname)) {
                nombres.value = result.data.names.trim()

                const paternal = result.data.paternalSurname?.trim() || ''
                const maternal = result.data.maternalSurname?.trim() || ''
                apellidos.value = `${paternal} ${maternal}`.trim()

                showSuccess(`✅ ${documentType.value} encontrado: ${result.data.fullName || `${nombres.value} ${apellidos.value}`}`)

                console.log('📋 Datos cargados:', {
                    nombres: nombres.value,
                    apellidos: apellidos.value,
                    documentType: documentType.value,
                    documentNumber: documentNumber.value
                })
            } else {
                showError(`⚠️ ${documentType.value} encontrado, pero faltan datos personales. Complete manualmente.`)
            }
        } else {
            showError(`❌ No se encontraron datos para el ${documentType.value} ${documentNumber.value}`)
        }
    } catch (error: any) {
        console.error(`💥 Error en la búsqueda de ${documentType.value}:`, error)

        if (error.statusCode === 400) {
            showError(`❌ ${documentType.value} inválido. Debe tener ${getSelectedDocumentType()?.maxLength} dígitos numéricos.`)
        } else if (error.statusCode === 429) {
            showError('⏳ Demasiadas consultas. Espere un momento antes de intentar nuevamente.')
        } else if (error.statusCode === 500) {
            showError('🔧 Error del servidor. Inténtelo más tarde.')
        } else if (error.statusCode === 403) {
            showError('🚫 Acceso no autorizado. Contacte al administrador.')
        } else {
            showError(`🌐 Error de conexión. Verifique su internet e inténtelo nuevamente.`)
        }
    } finally {
        isSearchingDni.value = false
    }
}

const handleFileChange = (event: Event) => {
    const target = event.target as HTMLInputElement
    const file = target.files ? target.files.item(0) : null

    if (file && !['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'].includes(file.type)) {
        showError('📎 Solo se permiten archivos JPG, PNG o PDF')
        target.value = ''
        return
    }

    if (file && file.size > 5 * 1024 * 1024) {
        showError('📏 El archivo no debe superar los 5MB')
        target.value = ''
        return
    }

    archivoVoucher.value = file
    if (file) {
        showSuccess(`📎 Archivo cargado: ${file.name}`)
    }
}

const handleSubmit = async () => {
    if (!selectedPlan.value) {
        showError('❌ Plan no válido')
        return
    }

    if (!tipoInscripcion.value) {
        showError('❌ Por favor selecciona un tipo de inscripción')
        return
    }

    // Validaciones adicionales
    if (isStudentPlan.value && !clasificacion.value) {
        showError('❌ Por favor selecciona tu clasificación')
        return
    }

    if (!modalidadDeposito.value) {
        showError('❌ Por favor selecciona la modalidad de depósito')
        return
    }

    const metodoDePago = modalidadDeposito.value === 'banco' ? tipoPago.value : aplicativo.value
    if (!metodoDePago) {
        showError('❌ Por favor selecciona el método de pago')
        return
    }

    if (!fechaPago.value) {
        showError('❌ Por favor indica la fecha de pago')
        return
    }

    if (!codigoVoucher.value) {
        showError('❌ Por favor ingresa el código del voucher')
        return
    }

    if (!archivoVoucher.value) {
        showError('❌ Por favor adjunta el voucher de pago')
        return
    }

    isSubmitting.value = true
    clearError()

    try {
        // Verificar que los catálogos estén cargados antes de procesar
        if (!registrationTypes.value?.length || !depositMethods.value?.length || !paymentTypes.value?.length) {
            console.warn('⚠️ Catálogos no cargados, intentando reinicializar...')
            await initializeCatalogs()

            // Dar un momento para que se carguen
            await new Promise(resolve => setTimeout(resolve, 100))

            if (!registrationTypes.value?.length || !depositMethods.value?.length || !paymentTypes.value?.length) {
                throw new Error('No se pudieron cargar los datos necesarios. Recargue la página e intente nuevamente.')
            }
        }

        // Mapeo de tipos de documento del frontend al backend
        const documentTypeMapped = documentType.value.toLowerCase()

        // El valor ya está correcto, no necesita mapeo adicional
        const tipoInscripcionMapped = tipoInscripcion.value

        // Preparar los datos del formulario con mapeo correcto
        const modalidadDepositoMapped = modalidadDeposito.value === 'banco' ? 'Banco de la Nación' : 'Billetera Digital'

        let metodoDePagoMapped = ''
        if (modalidadDeposito.value === 'banco') {
            metodoDePagoMapped = tipoPago.value === 'directo' ? 'Pago Directo' : 'Pago Interbancario'
        } else {
            metodoDePagoMapped = aplicativo.value === 'yape' ? 'Yape' : 'Plin'
        }

        const formData = {
            documentType: documentTypeMapped,
            documentNumber: documentNumber.value,
            nombres: nombres.value,
            apellidos: apellidos.value,
            email: email.value,
            celular: celular.value,
            clasificacion: clasificacion.value,
            tipoInscripcion: tipoInscripcionMapped,
            modalidadDeposito: modalidadDepositoMapped,
            metodoDePago: metodoDePagoMapped,
            fechaPago: fechaPago.value,
            codigoVoucher: codigoVoucher.value,
            archivoVoucher: archivoVoucher.value
        }

        console.log('� Datos del formulario preparados:', formData)
        console.log('📊 Catálogos disponibles:', {
            registrationTypes: registrationTypes.value,
            classifications: classifications.value,
            depositMethods: depositMethods.value,
            paymentTypes: paymentTypes.value
        })

        // Mapear datos del formulario a formato de API
        const apiData = mapFormDataToApiData(formData)

        console.log('� Datos mapeados para API:', apiData)

        // Enviar inscripción
        const response = await createInscription(apiData)

        console.log('✅ Inscripción completada:', response)

        // Verificar que la respuesta sea exitosa
        if (!response.success) {
            console.error('❌ Respuesta del servidor indica fallo:', response)
            showError(`Error: ${response.message || 'Error desconocido al crear la inscripción'}`)
            return
        }

        // Guardar el ID de la inscripción completada
        completedInscriptionId.value = response.data?.id || null

        if (!completedInscriptionId.value) {
            console.error('❌ No se obtuvo ID de inscripción válido:', response)
            showError('Error: No se pudo obtener el ID de la inscripción. Contacte con soporte.')
            return
        }

        console.log('🔄 Redirigiendo inmediatamente a confirmación...', {
            inscriptionId: completedInscriptionId.value,
            routerReady: !!router
        })

        // Redirigir inmediatamente a la página de confirmación
        try {
            await router.push(`/confirmation?id=${completedInscriptionId.value}`)
            console.log('✅ Redirección exitosa')
        } catch (navigationError) {
            console.error('❌ Error en navegación con router:', navigationError)
            // Fallback: usar window.location
            window.location.href = `/confirmation?id=${completedInscriptionId.value}`
        }

    } catch (error: any) {
        console.error('💥 Error al enviar formulario:', error)

        // Mostrar el error específico del composable si existe
        if (apiError.value) {
            showError(apiError.value)
        } else {
            showError('❌ Error al procesar la inscripción. Inténtelo nuevamente.')
        }
    } finally {
        isSubmitting.value = false
    }
}

// ===========================================================================
// FUNCIONES DE TRANSICIÓN PARA CAMPO DE CLASIFICACIÓN
// ===========================================================================
const onClassificationBeforeEnter = (el: Element) => {
    const htmlEl = el as HTMLElement
    htmlEl.style.height = '0'
    htmlEl.style.opacity = '0'
    htmlEl.style.overflow = 'hidden'
    htmlEl.style.transform = 'translateY(-20px)'
}

const onClassificationEnter = (el: Element, done: () => void) => {
    const htmlEl = el as HTMLElement

    // Forzar un reflow para asegurar que el estado inicial se aplique
    void htmlEl.offsetHeight

    // Obtener la altura natural del elemento
    htmlEl.style.height = 'auto'
    const height = htmlEl.offsetHeight
    htmlEl.style.height = '0'

    // Animar hasta la altura natural
    const animation = htmlEl.animate([
        {
            height: '0px',
            opacity: '0',
            transform: 'translateY(-20px)'
        },
        {
            height: `${height}px`,
            opacity: '1',
            transform: 'translateY(0)'
        }
    ], {
        duration: 600,
        easing: 'cubic-bezier(0.23, 1, 0.32, 1)',
        fill: 'forwards'
    })

    animation.onfinish = () => {
        htmlEl.style.height = 'auto'
        htmlEl.style.overflow = 'visible'
        done()
    }
}

const onClassificationAfterEnter = (el: Element) => {
    const htmlEl = el as HTMLElement
    htmlEl.style.height = 'auto'
    htmlEl.style.overflow = 'visible'
}

const onClassificationBeforeLeave = (el: Element) => {
    const htmlEl = el as HTMLElement
    const height = htmlEl.offsetHeight
    htmlEl.style.height = `${height}px`
    htmlEl.style.overflow = 'hidden'
}

const onClassificationLeave = (el: Element, done: () => void) => {
    const htmlEl = el as HTMLElement

    const animation = htmlEl.animate([
        {
            height: `${htmlEl.offsetHeight}px`,
            opacity: '1',
            transform: 'translateY(0)'
        },
        {
            height: '0px',
            opacity: '0',
            transform: 'translateY(-20px)'
        }
    ], {
        duration: 500,
        easing: 'cubic-bezier(0.23, 1, 0.32, 1)',
        fill: 'forwards'
    })

    animation.onfinish = done
}

const onClassificationAfterLeave = (el: Element) => {
    const htmlEl = el as HTMLElement
    htmlEl.style.height = ''
    htmlEl.style.opacity = ''
    htmlEl.style.transform = ''
    htmlEl.style.overflow = ''
}

// ===========================================================================
// INICIALIZACIÓN
// ===========================================================================
onMounted(async () => {
    // Inicializar catálogos de la API
    try {
        console.log('🔄 Inicializando catálogos...')
        await initializeCatalogs()
        console.log('✅ Catálogos inicializados')
    } catch (error) {
        console.error('💥 Error inicializando catálogos:', error)
        showError('Error al cargar datos iniciales. Algunos campos podrían no funcionar correctamente.')
    }

    // Configurar plan seleccionado
    if (!selectedPlan.value) {
        router.push('/register?planId=1')
    } else {
        // Preseleccionar el tipo de inscripción basado en el plan
        // Usar el value del plan seleccionado
        tipoInscripcion.value = selectedPlan.value.value
    }
})
</script>

<style scoped>
/* Page Layout & Banners */
.breadcrumb-area {
    position: relative;
    padding-top: 3.5rem;
    padding-bottom: 3.5rem;
    z-index: 1;
}

.breadcrumb-area::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url('/images/bg/breadcrumb_bg01.jpg');
    background-size: cover;
    background-position: center;
    z-index: -1;
}

.breadcrumb-container {
    max-width: 1320px;
    margin-left: auto;
    margin-right: auto;
    padding-left: 1rem;
    padding-right: 1rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}

.page-title {
    font-size: 2.25rem;
    line-height: 2.5rem;
    font-weight: 700;
    color: #ffffff;
    text-transform: uppercase;
    text-align: center;
    margin-bottom: 0.5rem;
}

.page-subtitle {
    color: #cbd5e1;
    font-size: 1.125rem;
    max-width: 32rem;
}

/* Plan Info Section */
.plan-info-section {
    padding-top: 2rem;
    padding-bottom: 2rem;
    background-color: #0f172a;
}

.plan-info-container {
    max-width: 1320px;
    margin-left: auto;
    margin-right: auto;
    padding-left: 1rem;
    padding-right: 1rem;
    display: flex;
    justify-content: center;
}

.plan-card {
    background-color: #1e293b;
    border: 1px solid #475569;
    border-radius: 0.75rem;
    padding: 2rem;
    max-width: 28rem;
    width: 100%;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.plan-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.plan-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #ffffff;
    text-transform: uppercase;
}

.plan-badge {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    border: 1px solid;
}

.badge-success {
    border-color: #45f882;
    color: #45f882;
}

.badge-warning {
    border-color: #fbbf24;
    color: #fbbf24;
}

.plan-price {
    font-size: 2.25rem;
    font-weight: 800;
    color: #45f882;
    margin-bottom: 1.5rem;
}

.plan-features {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.plan-feature {
    display: flex;
    align-items: center;
    color: #cbd5e1;
    margin-bottom: 0.75rem;
}

.feature-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: #45f882;
    margin-right: 0.75rem;
    flex-shrink: 0;
}

/* Form Sections */
.form-section {
    padding-top: 3rem;
    padding-bottom: 3rem;
}

.form-container {
    max-width: 80rem;
    margin-left: auto;
    margin-right: auto;
    padding-left: 1rem;
    padding-right: 1rem;
}

.registration-form {
    display: grid;
    grid-template-columns: repeat(6, minmax(0, 1fr));
    gap: 1.5rem;
    row-gap: 2rem;
}

/* Mejores transiciones para elementos específicos */
.registration-form>* {
    will-change: transform;
    transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
}

/* Document Input Group Styling */
.document-input-group {
    display: flex;
    border: 1px solid #475569;
    border-radius: 0.5rem;
    overflow: hidden;
    background-color: #1e293b;
    transition: all 300ms;
    min-height: 48px;
}

.document-input-group:focus-within {
    border-color: #45f882;
    box-shadow: 0 0 0 2px rgba(69, 248, 130, 0.2);
}

.document-type-container {
    position: relative;
    flex-shrink: 0;
    width: 80px;
    display: flex;
    align-items: center;
}

.document-type-select {
    width: 100%;
    height: 100%;
    padding: 0.75rem 0.5rem;
    padding-right: 1.5rem;
    background-color: #334155;
    border: none;
    color: #ffffff;
    font-size: 0.875rem;
    font-weight: 600;
    text-align: center;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    outline: none;
    cursor: pointer;
}

.document-type-select:focus {
    background-color: #475569;
}

.document-type-arrow {
    position: absolute;
    right: 0.25rem;
    top: 50%;
    transform: translateY(-50%);
    width: 1rem;
    height: 1rem;
    color: #94a3b8;
    pointer-events: none;
}

.document-number-container {
    display: flex;
    flex: 1;
    position: relative;
}

.document-number-input {
    flex: 1;
    padding: 0.75rem 1rem;
    background-color: transparent;
    border: none;
    color: #ffffff;
    outline: none;
}

.document-number-input::placeholder {
    color: #94a3b8;
}

.document-search-button {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    background-color: transparent;
    border: none;
    color: #94a3b8;
    cursor: pointer;
    transition: color 300ms;
    min-width: 48px;
    min-height: 48px;
    flex-shrink: 0;
    border-radius: 0.375rem;
}

.document-search-button:hover:not(:disabled) {
    color: #45f882;
    background-color: rgba(69, 248, 130, 0.1);
}

.document-search-button:disabled {
    color: #64748b;
    cursor: not-allowed;
}

.form-group {
    width: 100%;
    transition: transform 0.3s ease, opacity 0.3s ease;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    line-height: 1.25rem;
    font-weight: 500;
    color: #ffffff;
    margin-bottom: 0.5rem;
}

.form-input,
select.form-input {
    width: 100%;
    padding: 0.75rem 1rem;
    background-color: #1e293b;
    border: 1px solid #475569;
    border-radius: 0.5rem;
    color: #ffffff;
    transition-property: all;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 300ms;
}

.form-input::placeholder {
    color: #94a3b8;
}

.form-input:focus,
select.form-input:focus {
    outline: none;
    border-color: #45f882;
    box-shadow: 0 0 0 2px rgba(69, 248, 130, 0.2);
}

select.form-input {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
}

.form-input[readonly] {
    cursor: not-allowed;
}

.input-filled {
    background-color: #334155;
}

.form-input:valid {
    background-color: #334155;
}

select.form-input:valid {
    background-color: #334155;
}

input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus,
input:-webkit-autofill:active {
    -webkit-box-shadow: 0 0 0 30px #334155 inset !important;
    -webkit-text-fill-color: #ffffff !important;
    transition: background-color 2500s ease-in-out 0s;
}

input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
}

select.form-input:not(:valid) {
    color: #94a3b8;
}

input[type="date"]:not(:valid) {
    color: #94a3b8;
}

select.form-input:valid,
input[type="date"]:valid {
    color: #ffffff;
}

.form-hint {
    display: block;
    margin-top: 0.5rem;
    font-size: 0.75rem;
    line-height: 1rem;
    color: #94a3b8;
    font-style: italic;
}

/* Plan Cards Compact Styling - Similar a Digital Ocean */
.plan-cards-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
    /* Permitir overflow para tooltips */
    overflow: visible;
    padding-bottom: 2rem;
}

.plan-card-compact {
    position: relative;
    background-color: #1e293b;
    border: 2px solid #475569;
    border-radius: 0.75rem;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 300ms ease;
    min-height: 140px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    z-index: 1;
}

.plan-card-compact:hover {
    border-color: #64748b;
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    z-index: 10;
}

.plan-card-compact:hover .plan-info-tooltip-container {
    z-index: 9999;
}

.plan-card-compact.selected {
    border-color: #45f882;
    background-color: rgba(69, 248, 130, 0.05);
    box-shadow: 0 0 0 1px rgba(69, 248, 130, 0.2);
}

.plan-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.plan-card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #ffffff;
    text-transform: uppercase;
    margin: 0;
    line-height: 1.2;
}

.plan-price-container {
    display: flex;
    align-items: flex-start;
    gap: 0.25rem;
    margin-bottom: 0.5rem;
}

.plan-card-price {
    font-size: 1.75rem;
    font-weight: 800;
    color: #45f882;
    line-height: 1;
    margin: 0;
}

.plan-card-badge {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    padding: 0.1rem 0.25rem;
    border-radius: 0.2rem;
    border: 1px solid;
    white-space: nowrap;
    flex-shrink: 0;
    align-self: flex-start;
    line-height: 1;
    margin-top: 0.1rem;
    transform: translateY(-0.2rem);
}

.plan-card-description {
    font-size: 0.85rem;
    color: #94a3b8;
    line-height: 1.3;
    margin-bottom: 1rem;
    flex-grow: 1;
}

.plan-card-selector {
    position: absolute;
    top: 1rem;
    right: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.plan-selector-radio {
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #475569;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 300ms;
    background-color: #1e293b;
}

.plan-selector-radio.selected {
    background-color: #45f882;
    border-color: #45f882;
}

.plan-selector-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 9999px;
    background-color: #000000;
}

/* Radio Button Styling */
.radio-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.radio-group-horizontal {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem 1.5rem;
}

.radio-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 0.875rem;
    color: #cbd5e1;
}

.radio-custom-indicator {
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #475569;
    border-radius: 9999px;
    margin-right: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 300ms;
}

.radio-custom-indicator.selected {
    background-color: #45f882;
    border-color: #45f882;
}

.radio-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 9999px;
    background-color: #000000;
}

/* File Input Styling */
.file-input-wrapper {
    display: flex;
    align-items: center;
    width: 100%;
    background-color: #1e293b;
    border: 1px solid #475569;
    border-radius: 0.5rem;
    transition: all 300ms;
    cursor: pointer;
    overflow: hidden;
}

.file-input-wrapper:hover {
    border-color: #45f882;
}

.file-input-wrapper.file-input-completed {
    background-color: #334155;
}

.file-input-button {
    background-color: #475569;
    color: #ffffff;
    padding: 0.75rem 1rem;
    white-space: nowrap;
    transition: background-color 300ms;
}

.file-input-wrapper:hover .file-input-button {
    background-color: #5a6a7e;
}

.file-input-text-area {
    padding: 0.75rem 1rem;
    color: #94a3b8;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-grow: 1;
}

.file-input-wrapper.file-input-completed .file-input-text-area {
    color: #ffffff;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

/* Submit Button */
.submit-button {
    width: 100%;
    background-color: #45f882;
    color: #000000;
    font-weight: 600;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    transition: all 300ms;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    font-size: 1rem;
}

.submit-button:hover:not(:disabled) {
    background-color: #34d399;
    transform: translateY(-1px);
}

.submit-button:disabled {
    background-color: #64748b;
    cursor: not-allowed;
}

/* Tooltip Styling */
.tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 0.75rem;
    padding: 0.5rem 0.75rem;
    background-color: #111827;
    color: #ffffff;
    font-size: 0.75rem;
    border-radius: 0.375rem;
    text-align: left;
    min-width: max-content;
    opacity: 0;
    transition: opacity 0.3s, transform 0.3s;
    pointer-events: none;
    z-index: 10;
}

.group:hover .tooltip {
    opacity: 1;
    transform: translateX(-50%) translateY(-5px);
}

.tooltip-arrow {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid #111827;
}

/* Conditional Section Styling */
.conditional-section {
    background-color: rgba(30, 41, 59, 0.5);
    padding: 1rem;
    border-radius: 0.5rem;
    border: 1px solid #475569;
}

.fade-enter-active,
.fade-leave-active {
    transition: all 0.4s ease;
}

.fade-enter-from,
.fade-leave-to {
    opacity: 0;
    transform: translateY(-10px);
}

/* TRANSICIONES MEJORADAS PARA CAMPO DE CLASIFICACIÓN */
.classification-container {
    overflow: hidden;
}

.height-expand-enter-active {
    transition: none;
    /* Las transiciones se manejan con JS */
}

.height-expand-leave-active {
    transition: none;
    /* Las transiciones se manejan con JS */
}

/* Mejores transiciones para elementos que siguen al campo de clasificación */
.form-section-below-classification {
    transition:
        transform 0.6s cubic-bezier(0.23, 1, 0.32, 1),
        margin-top 0.5s cubic-bezier(0.23, 1, 0.32, 1),
        opacity 0.4s ease-out;
    will-change: transform, margin-top;
    transform-origin: top center;
}

/* Estilo global para suavizar transiciones en toda la grilla */
.registration-form {
    transition: height 0.5s cubic-bezier(0.23, 1, 0.32, 1);
}

.registration-form>* {
    transition:
        transform 0.6s cubic-bezier(0.23, 1, 0.32, 1),
        opacity 0.4s ease-out,
        margin 0.5s cubic-bezier(0.23, 1, 0.32, 1);
    will-change: transform;
}

/* Responsive title */
@media (min-width: 640px) {
    .page-title {
        font-size: 3rem;
        line-height: 1;
    }
}

/* Responsive para las cards de planes */
@media (max-width: 768px) {
    .plan-cards-container {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }

    .plan-card-compact {
        padding: 1rem;
        min-height: 120px;
    }

    .plan-card-title {
        font-size: 1rem;
    }

    .plan-card-price {
        font-size: 1.5rem;
    }

    .plan-card-badge {
        font-size: 0.45rem;
        padding: 0.08rem 0.2rem;
        margin-top: 0.08rem;
        transform: translateY(-0.15rem);
    }

    .plan-card-description {
        font-size: 0.8rem;
    }

    .plan-card-selector {
        top: 0.75rem;
        right: 0.75rem;
    }

    .plan-price-container {
        align-items: flex-start;
        gap: 0.2rem;
    }
}

@media (min-width: 1024px) {
    .plan-cards-container {
        grid-template-columns: repeat(3, 1fr);
    }
}

/* Plan Tooltip Styling */
.plan-title-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
}

.plan-info-tooltip-container {
    position: relative;
    display: inline-block;
    /* Asegurar que el tooltip tenga espacio suficiente */
    overflow: visible;
}

.plan-info-icon {
    width: 1.5rem;
    height: 1.5rem;
    color: #93a4bd;
    cursor: help;
    transition: color 300ms;
    flex-shrink: 0;
}

.plan-info-icon:hover {
    color: #45f882;
}

.plan-tooltip {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-top: 0.75rem;
    padding: 1rem;
    background-color: #111827;
    border: 1px solid #374151;
    color: #ffffff;
    border-radius: 0.75rem;
    min-width: 250px;
    max-width: 320px;
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 20;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    /* Evitar que se corte en los bordes */
    margin-left: auto;
    margin-right: auto;
}

.plan-info-tooltip-container:hover .plan-tooltip {
    opacity: 1;
    transform: translateX(-50%) translateY(8px);
    pointer-events: auto;
}

.plan-tooltip-title {
    font-size: 0.9rem;
    font-weight: 700;
    color: #45f882;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
    text-align: center;
}

.plan-tooltip-price {
    font-size: 1.5rem;
    font-weight: 800;
    color: #45f882;
    text-align: center;
    margin-bottom: 1rem;
}

.plan-tooltip-features {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.plan-tooltip-feature {
    display: flex;
    align-items: center;
    color: #e5e7eb;
    font-size: 0.825rem;
}

.plan-feature-icon {
    width: 1rem;
    height: 1rem;
    color: #45f882;
    margin-right: 0.5rem;
    flex-shrink: 0;
}

.plan-feature-icon.feature-excluded {
    color: #ef4444;
}

.feature-excluded-text {
    color: #9ca3af;
    text-decoration: line-through;
}

.plan-tooltip-arrow {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-bottom: 8px solid #111827;
}

/* Responsive para el botón de búsqueda */
@media (max-width: 640px) {
    .document-search-button {
        min-width: 44px;
        min-height: 44px;
        padding: 0.375rem;
    }

    .document-input-group {
        min-height: 44px;
    }

    .document-type-select {
        font-size: 0.8rem;
        padding: 0.5rem 0.25rem;
        padding-right: 1.25rem;
    }

    .document-number-input {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }

    .plan-card {
        padding: 1.5rem;
    }

    .plan-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    /* Responsive para tooltips de planes */
    .plan-tooltip {
        min-width: 200px;
        max-width: 90vw;
        left: 50%;
        transform: translateX(-50%);
        margin-left: 0;
        margin-right: 0;
        padding: 0.75rem;
        font-size: 0.75rem;
        background-color: #111827 !important;
        border: 1px solid #374151 !important;
        z-index: 9999 !important;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5) !important;
        opacity: 0;
        backdrop-filter: blur(8px);
    }

    .plan-info-tooltip-container:hover .plan-tooltip {
        transform: translateX(-50%) translateY(8px);
        opacity: 1 !important;
    }

    .plan-tooltip-arrow {
        left: 50%;
        transform: translateX(-50%);
    }

    .plan-tooltip-features {
        gap: 0.5rem;
    }

    .plan-tooltip-feature {
        font-size: 0.75rem;
    }

    .plan-feature-icon {
        width: 0.875rem;
        height: 0.875rem;
        margin-right: 0.375rem;
    }
}

/* Responsive específico para pantallas muy pequeñas */
@media (max-width: 480px) {
    .plan-tooltip {
        min-width: 180px;
        max-width: 85vw;
        padding: 0.625rem;
        font-size: 0.7rem;
        left: 50%;
        transform: translateX(-50%);
        margin-left: 0.5rem;
        margin-right: 0.5rem;
        background-color: #0f172a !important;
        border: 2px solid #374151 !important;
        z-index: 9999 !important;
        box-shadow: 0 20px 45px rgba(0, 0, 0, 0.6) !important;
        backdrop-filter: blur(12px);
        color: #ffffff !important;
    }

    .plan-info-tooltip-container:hover .plan-tooltip {
        transform: translateX(-50%) translateY(6px);
        opacity: 1 !important;
    }

    .plan-tooltip-title {
        font-size: 0.8rem;
        margin-bottom: 0.375rem;
    }

    .plan-tooltip-price {
        font-size: 1.25rem;
        margin-bottom: 0.75rem;
    }

    .plan-tooltip-features {
        gap: 0.4rem;
    }

    .plan-tooltip-feature {
        font-size: 0.7rem;
    }

    .plan-feature-icon {
        width: 0.8rem;
        height: 0.8rem;
        margin-right: 0.3rem;
    }
}
</style>